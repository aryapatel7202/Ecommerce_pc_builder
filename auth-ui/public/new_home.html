<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC MART - PC Store</title>
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeOutDown: {
                            '0%': { opacity: '1', transform: 'translateY(0)' },
                            '100%': { opacity: '0', transform: 'translateY(20px)' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.5s ease-out forwards',
                        fadeOutDown: 'fadeOutDown 0.5s ease-out forwards'
                    }
                },
            },
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
        
        body, .page, h1, h2, h3, p {
            transition: color 0.5s ease, background-color 0.5s ease;
        }

        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeInUp 0.5s ease-in-out;
        }

        .build-step {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .scroll-animate {
            opacity: 0;
            transition: opacity 0.7s ease-out, transform 0.7s ease-out;
            transform: translateY(30px);
        }

        .scroll-animate.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .component-card, .prebuild-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
        }

        .component-card:hover, .prebuild-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .component-card.selected {
            border-color: #3B82F6; /* blue-500 */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); /* blue-500 with opacity */
        }
        
        .filter-select {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem; /* room for arrow */
            border-radius: 0.5rem;
            border: 1px solid rgba(209, 213, 219, 1); /* gray-300 */
            background-color: rgba(243, 244, 246, 1); /* gray-100 */
            color: rgba(17, 24, 39, 1); /* gray-900 */
            outline: none;
            transition: box-shadow .15s ease, border-color .15s ease, background-color .3s ease, color .3s ease;
            appearance: none; /* hide default arrow */
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.65rem center;
            background-size: 1.1rem;
        }

        .dark .filter-select {
            background-color: rgba(75, 85, 99, 1);    /* gray-600 */
            border-color: rgba(107, 114, 128, 1);      /* gray-500 */
            color: rgba(255, 255, 255, 0.95);
        }

        .filter-select:focus {
            border-color: rgb(59, 130, 246); /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .35);
        }

        .filter-select::-ms-expand { display: none; }

        /* Cropper.js custom styles */
        #image-to-crop-container {
            height: 40vh; /* Limit height for preview */
        }
        .cropper-view-box,
        .cropper-face {
            border-radius: 50%;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-white">

    <header class="bg-gray-900 text-white shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto p-4 flex items-center justify-between">
            <div class="text-2xl font-bold text-blue-400">
                <a href="#home" class="flex items-center space-x-2 transition-transform transform hover:scale-105 duration-200">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 12L12 22L22 12L12 2Z" fill="#3B82F6"/>
                        <path d="M12 2L22 12H12V2Z" fill="#1D4ED8"/>
                        <path d="M12 22L2 12H12V22Z" fill="#2563EB"/>
                    </svg>
                    <span>PC MART</span>
                </a>
            </div>

            <div class="md:hidden">
                <button id="menu-btn" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>

            <div class="hidden md:flex space-x-6 items-center" id="nav-menu">
                <a href="#home" class="nav-link flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="#build-pc" class="nav-link flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L14.25 17M9.75 17l-1-4h7.5l-1 4M9.75 17h4.5M12 4v16M8.5 7h7M5 19h14M16 11H8"></path>
                    </svg>
                    <span>Build Your PC</span>
                </a>
                <a href="#prebuilds" class="nav-link flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7H4a2 2 0 00-2 2v6a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2zM4 7V5a2 2 0 012-2h12a2 2 0 012 2v2M4 11h16M4 15h16"></path>
                    </svg>
                    <span>Prebuilds</span>
                </a>
                <a href="#about-us" class="nav-link flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>About Us</span>
                </a>
                <a href="#account" class="nav-link flex items-center space-x-2 p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>Account</span>
                </a>
                <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-700 transition-colors duration-200">
                    <svg id="sun-icon" class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moon-icon" class="w-5 h-5 text-indigo-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 pb-4">
            <a href="#home" class="nav-link flex items-center space-x-2 p-4 block hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span>Home</span>
            </a>
            <a href="#build-pc" class="nav-link flex items-center space-x-2 p-4 block hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L14.25 17M9.75 17l-1-4h7.5l-1 4M9.75 17h4.5M12 4v16M8.5 7h7M5 19h14M16 11H8"></path>
                </svg>
                <span>Build Your PC</span>
            </a>
            <a href="#prebuilds" class="nav-link flex items-center space-x-2 p-4 block hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7H4a2 2 0 00-2 2v6a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2zM4 7V5a2 2 0 012-2h12a2 2 0 012 2v2M4 11h16M4 15h16"></path>
                </svg>
                <span>Prebuilds</span>
            </a>
            <a href="#about-us" class="nav-link flex items-center space-x-2 p-4 block hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>About Us</span>
            </a>
            <a href="#account" class="nav-link flex items-center space-x-2 p-4 block hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>Account</span>
            </a>
            <button id="theme-toggle-mobile" class="p-4 w-full text-left rounded-md hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
                 <svg id="sun-icon-mobile" class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <svg id="moon-icon-mobile" class="w-5 h-5 text-indigo-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <span>Toggle Theme</span>
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-8">
        <div id="home-page" class="page active space-y-16 sm:space-y-24">
            <!-- Hero Section -->
            <section class="text-center scroll-animate">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4">Build Your Dream PC Today</h1>
                <p class="text-lg sm:text-xl text-gray-700 dark:text-gray-400 max-w-3xl mx-auto mb-8">From high-performance gaming rigs to powerful workstations, we provide the best components and expert guidance to bring your vision to life.</p>
                <a href="#build-pc" class="nav-link-cta bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-transform transform hover:scale-105 duration-300 inline-block">
                    Start Building
                </a>
            </section>

            <!-- Why Choose Us Section -->
            <section class="scroll-animate">
                <h2 class="text-3xl sm:text-4xl font-bold text-center mb-12">Why PC MART?</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
                        <div class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4">
                           <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3"></path><circle cx="12" cy="12" r="4"></circle></svg>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Quality Components</h3>
                        <p class="text-gray-600 dark:text-gray-400">We source only the best parts from trusted brands to ensure reliability and performance.</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
                        <div class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Limitless Customization</h3>
                        <p class="text-gray-600 dark:text-gray-400">Our intuitive PC builder gives you the freedom to pick and choose every single component.</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
                        <div class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Expert Support</h3>
                        <p class="text-gray-600 dark:text-gray-400">Our team is here to help you with compatibility checks, build advice, and support.</p>
                    </div>
                </div>
            </section>

            <!-- Contact Us Section -->
            <section class="scroll-animate">
                <h2 class="text-3xl sm:text-4xl font-bold text-center mb-12">Get In Touch</h2>
                <div class="max-w-5xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Contact Information</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Have questions or need help with a build? Reach out to us! We're always happy to help.</p>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span class="text-gray-700 dark:text-gray-300">Gokuldham society, powder gali</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                <span class="text-gray-700 dark:text-gray-300">8460931493</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <span class="text-gray-700 dark:text-gray-300">aryapatel7202@gmail.com</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <form action="#" method="POST">
                            <div class="space-y-4">
                                <div>
                                    <label for="name" class="sr-only">Name</label>
                                    <input type="text" name="name" id="name" class="w-full p-3 rounded-md bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" placeholder="Your Name">
                                </div>
                                <div>
                                    <label for="email" class="sr-only">Email</label>
                                    <input type="email" name="email" id="email" class="w-full p-3 rounded-md bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" placeholder="Your Email">
                                </div>
                                <div>
                                    <label for="message" class="sr-only">Message</label>
                                    <textarea name="message" id="message" rows="4" class="w-full p-3 rounded-md bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500" placeholder="Your Message"></textarea>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 transition-colors duration-300">
                                    Send Message
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </div>

        <div id="build-pc-page" class="page">
            <h1 class="text-4xl font-bold text-center mb-4">Build Your PC</h1>
            
            <div id="disclaimer-panel" class="p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 mb-8">
                <h2 class="text-xl font-semibold mb-4">A Note on Building a PC</h2>
                <p>Building a custom PC requires technical knowledge and attention to detail. Please ensure that all selected components are compatible with each other and that you have the necessary skills to assemble them correctly. PC MART is not responsible for any damage caused by improper assembly.</p>
                <div class="mt-4 flex items-center space-x-2">
                    <input type="checkbox" id="agree-checkbox" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                    <label for="agree-checkbox" class="font-medium text-sm md:text-base">I understand and agree to the terms.</label>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="start-build-btn" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-full hover:bg-yellow-600 transition-colors disabled:opacity-50" disabled>Start Building</button>
                </div>
            </div>
            
            <div id="step-1" class="build-step p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-white dark:bg-gray-800 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-blue-500">Step 1: Choose Your Foundation</h2>
                <div class="space-y-6">
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">Cabinet: <span id="selected-cabinet" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="cabinet">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">Motherboard: <span id="selected-motherboard" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="motherboard">Select</button>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button id="next-step-1" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>

            <div id="step-2" class="build-step p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-white dark:bg-gray-800 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-blue-500">Step 2: Choose Your Components</h2>
                <div class="space-y-6">
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">CPU: <span id="selected-cpu" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="cpu">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">Cooler: <span id="selected-cooler" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="cooler">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">RAM: <span id="selected-ram" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="ram">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">GPU: <span id="selected-gpu" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="gpu">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">PSU: <span id="selected-psu" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="psu">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">SSD: <span id="selected-ssd" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="ssd">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">HDD: <span id="selected-hdd" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="hdd">Select</button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <span class="font-medium">OS: <span id="selected-os" class="text-gray-500 dark:text-gray-400">None</span></span>
                        <button class="select-component-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors" data-type="os">Select</button>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="prev-step-2" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-600 transition-colors duration-200">Previous</button>
                    <button id="finalize-build-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50" disabled>Finalize Build</button>
                </div>
            </div>

            <div id="component-selection-view" class="build-step p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-white dark:bg-gray-800 hidden">
                <div class="flex justify-between items-center mb-4">
                    <button id="back-to-builder-btn" class="text-blue-500 hover:text-blue-600 transition-colors font-semibold flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        <span>Back to Builder</span>
                    </button>
                    <button id="deselect-component-btn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors font-semibold flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        <span>Clear Selection</span>
                    </button>
                </div>
                <h2 id="component-selection-title" class="text-2xl font-semibold mb-6 text-blue-500">Select Component</h2>
                
                <div id="filter-container" class="mb-6"></div>

                <div id="component-card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </div>
            
            <div id="step-3" class="build-step p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-white dark:bg-gray-800 hidden">
                <h2 class="text-2xl font-semibold mb-6 text-blue-500">Step 3: Summary & Finalize Order</h2>
                <div id="build-summary" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4">Your Custom PC</h3>
                    <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                    </ul>
                </div>

                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-2xl font-bold">Total Price: <span id="total-price" class="text-blue-500">₹0.00</span></h3>
                    <div class="flex items-center space-x-2">
                        <label for="build-quantity" class="text-lg">Quantity:</label>
                        <input type="number" id="build-quantity" value="1" min="1" max="10" class="w-20 p-2 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-500 text-center">
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button id="prev-step-3" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-600 transition-colors duration-200">Previous</button>
                    <div class="space-x-4">
                        <button id="save-build" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-full hover:bg-gray-800 transition-colors duration-200">Save</button>
                        <button id="add-to-cart" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600 transition-colors duration-200">Add to Cart</button>
                        <button id="buy-now" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition-colors duration-200">Buy Now</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="prebuilds-page" class="page">
             <h1 class="text-4xl font-bold text-center mb-4">Pre-Built PCs</h1>
             <p class="text-center text-gray-700 dark:text-gray-400 mb-8 max-w-2xl mx-auto">Expertly crafted builds for every need and budget. Select a pre-built PC to see details, or use it as a starting point for your own custom creation.</p>
            
             <div class="mb-8 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md max-w-4xl mx-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="category-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Use</label>
                        <select id="category-filter" class="filter-select">
                            <option value="all">All Categories</option>
                            <option value="Gaming">Gaming</option>
                            <option value="Professional (Video/Photo Editing)">Professional (Video/Photo Editing)</option>
                            <option value="Professional (Graphic Design)">Professional (Graphic Design)</option>
                            <option value="Normal">Normal Use</option>
                        </select>
                    </div>
                     <div>
                        <label for="price-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Price</label>
                        <select id="price-filter" class="filter-select">
                            <option value="all">All Prices</option>
                            <option value="0-50000">Under ₹50,000</option>
                            <option value="50000-100000">₹50,000 - ₹1,00,000</option>
                            <option value="100000-150000">₹1,00,000 - ₹1,50,000</option>
                            <option value="150000-9999999">Over ₹1,50,000</option>
                        </select>
                    </div>
                </div>
             </div>

             <div id="prebuild-card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Pre-built PC cards will be rendered here by JS -->
             </div>
        </div>
        <div id="about-us-page" class="page space-y-16 sm:space-y-24">
            <section class="text-center scroll-animate">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-4">About PC MART</h1>
                <p class="text-lg sm:text-xl text-gray-700 dark:text-gray-400 max-w-3xl mx-auto">We are a team of passionate PC enthusiasts dedicated to helping everyone experience the joy of a custom-built computer.</p>
            </section>

            <section class="max-w-4xl mx-auto scroll-animate">
                <div class="bg-white dark:bg-gray-800 p-8 sm:p-12 rounded-lg shadow-lg flex flex-col md:flex-row items-center gap-8">
                    <div class="md:w-1/2">
                        <h2 class="text-3xl font-bold mb-4">Our Story</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            PC MART was founded in a small garage by a group of friends who believed that building a PC should be an accessible and rewarding experience. Frustrated by the complexity and gatekeeping in the custom PC world, we set out to create a platform that simplifies the process, educates users, and provides top-tier components at fair prices.
                        </p>
                        <p class="text-gray-600 dark:text-gray-400">
                            Today, we've grown into a trusted name for builders of all skill levels, but our core mission remains the same: to empower you to build the perfect PC for your needs.
                        </p>
                    </div>
                    <div class="md:w-1/2">
                        <img src="https://placehold.co/600x400/3B82F6/FFFFFF?text=Our+Workspace" alt="PC MART Workspace" class="rounded-lg shadow-md">
                    </div>
                </div>
            </section>

            <section class="scroll-animate">
                <h2 class="text-3xl sm:text-4xl font-bold text-center mb-12">Meet The Team</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 max-w-2xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center">
                        <h3 class="text-2xl font-bold mb-2">ARYA PATEL</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Co-Founder</p>
                        <a href="https://www.instagram.com/aryapatel_8460/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-2 px-6 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                            Visit Instagram
                        </a>
                    </div>
                     <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center">
                        <h3 class="text-2xl font-bold mb-2">DHUN ACHARYA</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Co-Founder</p>
                        <a href="https://www.instagram.com/aryapatel_8460/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-2 px-6 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                            Visit Instagram
                        </a>
                    </div>
                </div>
            </section>
        </div>
        <div id="account-page" class="page px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-center mb-8">My Account</h1>

            <div id="account-panel" class="max-w-md mx-auto bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 sm:p-8 text-center flex flex-col items-center">
                
                <div id="profile-container" class="mb-4 relative flex justify-center">
                    <!-- Profile picture is rendered here by JS -->
                </div>

                <input type="file" id="profile-upload" class="hidden" accept="image/*">

                <div id="greeting-container" class="flex items-center justify-center gap-2 text-xl sm:text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-4">
                    <!-- Greeting message and edit button are rendered here by JS -->
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-3 sm:gap-4 w-full sm:w-auto">
                    <button id="auth-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors w-full sm:w-auto">
                        Login
                    </button>
                </div>
            </div>
            
            <div id="account-data" class="mt-6 w-full max-w-4xl mx-auto">
              <div class="flex justify-center space-x-6 border-b pb-2 mb-4">
                <button class="account-tab font-bold text-blue-500" data-tab="saved">Saved</button>
                <button class="account-tab" data-tab="cart">Cart</button>
                <button class="account-tab" data-tab="orders">Orders</button>
              </div>
              
              <div id="saved-tab" class="account-tab-content"></div>
              <div id="cart-tab" class="account-tab-content hidden grid grid-cols-1 md:grid-cols-2 gap-6"></div>
              <div id="orders-tab" class="account-tab-content hidden"></div>
            </div>
        </div>

        <!-- NEW: Component Details Page -->
        <div id="component-details-page" class="page">
            <!-- This will be a new view, populated by JS -->
        </div>
        
        <!-- NEW: Prebuild Details Modal -->
        <div id="prebuild-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[100]">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-600">
                    <h3 id="prebuild-details-title" class="text-xl font-bold text-gray-800 dark:text-gray-200">
                        Build Details
                    </h3>
                    <button id="close-prebuild-details-btn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="prebuild-details-content" class="p-6 overflow-y-auto">
                    <!-- Details will be rendered here -->
                </div>
            </div>
        </div>


        <!-- Modals for various actions -->
        <div id="crop-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[100]">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
                <h3 class="text-xl font-bold p-4 text-center text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-600 flex-shrink-0">
                    Adjust Photo
                </h3>
                <div class="p-4 flex-grow relative" id="image-to-crop-container">
                    <img id="image-to-crop" src="" class="max-w-full max-h-full">
                </div>
                <div class="flex justify-between p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 flex-shrink-0">
                    <button id="cancel-crop-btn" type="button" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="set-crop-btn" type="button" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Set
                    </button>
                </div>
            </div>
        </div>

        <div id="edit-username-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[100]">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm flex flex-col">
                <h3 class="text-xl font-bold p-4 text-center text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-600">
                    Change Username
                </h3>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="new-username-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 text-left">New Username</label>
                        <input type="text" id="new-username-input" class="w-full p-2 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500">
                        <p id="username-error-msg" class="text-red-500 text-sm mt-1 h-4 text-left"></p>
                    </div>
                </div>
                <div class="flex justify-end p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 space-x-3">
                    <button id="cancel-username-btn" type="button" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="save-username-btn" type="button" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[101]">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm flex flex-col">
                <div id="custom-alert-content" class="p-6 text-center text-gray-800 dark:text-gray-200">
                    <!-- Message goes here -->
                </div>
                <div class="flex justify-center p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
                    <button id="custom-alert-ok-btn" type="button" class="px-8 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[101]">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm flex flex-col">
                <div id="custom-confirm-content" class="p-6 text-center text-gray-800 dark:text-gray-200">
                    <!-- Message goes here -->
                </div>
                <div class="flex justify-end p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 space-x-3">
                    <button id="custom-confirm-cancel-btn" type="button" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="custom-confirm-ok-btn" type="button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
  // --- GLOBAL CONFIG & ELEMENTS ---
  const API_BASE_URL = "http://localhost:6969"; // change this to your backend

  // Clean up bad local value like "null"
  if (localStorage.getItem('profile_picture') === 'null') {
    localStorage.removeItem('profile_picture');
  }
  // FIX: Added cleanup for 'userid' which might be incorrectly stored as the string "null",
  // causing API requests to fail on page load with an existing token.
  if (localStorage.getItem('userid') === 'null') {
    localStorage.removeItem('userid');
  }


  // Read expiry in ms (supports seconds or ms)
  function readExpiryMs() {
    const raw = localStorage.getItem('token_expiry');
    if (!raw) return 0;
    let exp = parseInt(raw, 10);
    if (exp && exp < 1e12) exp *= 1000; // convert seconds → ms
    return exp;
  }

  // Account page elements
  const greetingContainer = document.getElementById('greeting-container');
  const authButton = document.getElementById('auth-btn');
  const profileContainer = document.getElementById('profile-container');
  const profileUploadInput = document.getElementById('profile-upload');

  // Cropping Modal elements
  const cropModal = document.getElementById('crop-modal');
  const imageToCrop = document.getElementById('image-to-crop');
  const setCropBtn = document.getElementById('set-crop-btn');
  const cancelCropBtn = document.getElementById('cancel-crop-btn');
  let cropper = null;

  // Edit Username Modal elements
  const editUsernameModal = document.getElementById('edit-username-modal');
  const newUsernameInput = document.getElementById('new-username-input');
  const saveUsernameBtn = document.getElementById('save-username-btn');
  const cancelUsernameBtn = document.getElementById('cancel-username-btn');
  const usernameErrorMsg = document.getElementById('username-error-msg');

  // Custom Alert/Confirm Modal elements
  const customAlertModal = document.getElementById('custom-alert-modal');
  const customAlertContent = document.getElementById('custom-alert-content');
  const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
  const customConfirmModal = document.getElementById('custom-confirm-modal');
  const customConfirmContent = document.getElementById('custom-confirm-content');
  const customConfirmOkBtn = document.getElementById('custom-confirm-ok-btn');
  const customConfirmCancelBtn = document.getElementById('custom-confirm-cancel-btn');

  // --- HELPERS ---
  function showAlert(message) {
    customAlertContent.textContent = message;
    customAlertModal.classList.remove('hidden');
  }

  function showConfirm(message) {
    return new Promise((resolve) => {
      customConfirmContent.textContent = message;
      customConfirmModal.classList.remove('hidden');
      customConfirmOkBtn.onclick = () => { customConfirmModal.classList.add('hidden'); resolve(true); };
      customConfirmCancelBtn.onclick = () => { customConfirmModal.classList.add('hidden'); resolve(false); };
    });
  }

  function toPhotoSrc(pathOrUrl) {
    if (!pathOrUrl) return null;
    if (/^https?:\/\//i.test(pathOrUrl)) return pathOrUrl;
    return `${API_BASE_URL}${pathOrUrl.startsWith('/') ? '' : '/'}${pathOrUrl}`;
  }

  // --- ACCOUNT MANAGEMENT ---
  async function uploadProfilePicture(userId, file) {
    if (!file) return showAlert("Please select a file first!");
    const token = localStorage.getItem('token');
    if (!token || !userId) return showAlert('Error: Not logged in. Cannot upload picture.');

    try {
      const formData = new FormData();
      formData.append("file", file, "profile.jpg");
      const response = await fetch(`${API_BASE_URL}/api/users/${userId}/profile-picture`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });

      if (response.ok) {
        let profileUrl = null;
        try {
          const result = await response.json();
          profileUrl = result?.profile_picture_url || null;
        } catch (_) {
          // 204 or empty body – fall back to /api/users/me
        }

        if (!profileUrl) {
          try {
            const meRes = await fetch(`${API_BASE_URL}/api/users/me`, {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            if (meRes.ok) {
              const me = await meRes.json();
              profileUrl = me.profile_picture_url || null;
            }
          } catch (_) {}
        }

        if (profileUrl) localStorage.setItem('profile_picture', profileUrl);
        else localStorage.removeItem('profile_picture');

        showAlert("Profile picture uploaded successfully!");
        renderLoggedIn();
      } else {
        const errorText = await response.text();
        console.error("Failed to upload profile picture:", errorText);
        showAlert(`Error: ${errorText}`);
      }
    } catch (error) {
      console.error("Network error:", error);
      showAlert("A network error occurred. Please try again.");
    }
  }

  async function removeProfilePicture() {
    const confirmed = await showConfirm('Are you sure you want to remove your profile picture?');
    if (!confirmed) return;

    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userid');
    if (!token || !userId) return showAlert('Error: Not logged in or user ID is missing. Cannot delete picture.');

    try {
      const response = await fetch(`${API_BASE_URL}/api/users/${userId}/profile-picture`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        // Re-hydrate to confirm server state
        try {
          const meRes = await fetch(`${API_BASE_URL}/api/users/me`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (meRes.ok) {
            const me = await meRes.json();
            if (me.profile_picture_url) localStorage.setItem('profile_picture', me.profile_picture_url);
            else localStorage.removeItem('profile_picture');
          } else {
            localStorage.removeItem('profile_picture');
          }
        } catch (_) {
          localStorage.removeItem('profile_picture');
        }

        showAlert('Profile picture removed successfully!');
        renderLoggedIn();
      } else {
        const errorText = await response.text();
        console.error('Failed to remove profile picture:', errorText);
        showAlert(`Error: ${errorText}`);
      }
    } catch (error) {
      console.error('Network or server error:', error);
      showAlert('A network error occurred. Please try again.');
    }
  }

  function handleProfileUpload() { profileUploadInput.click(); }

  function openEditUsernameModal() {
    const currentUsername = localStorage.getItem('username');
    newUsernameInput.value = currentUsername || '';
    usernameErrorMsg.textContent = '';
    editUsernameModal.classList.remove('hidden');
    newUsernameInput.focus();
  }

  function closeEditUsernameModal() {
    editUsernameModal.classList.add('hidden');
    newUsernameInput.value = '';
    usernameErrorMsg.textContent = '';
  }

  async function handleUsernameSave() {
    const newUsername = newUsernameInput.value.trim();
    const currentUsername = localStorage.getItem('username');
    const userId = localStorage.getItem('userid');
    const token = localStorage.getItem('token');
    usernameErrorMsg.textContent = '';

    if (!newUsername) return usernameErrorMsg.textContent = 'Username cannot be empty.';
    if (newUsername === currentUsername) return closeEditUsernameModal();
    if (!/^[a-z][a-z0-9]*$/.test(newUsername)) return usernameErrorMsg.textContent = 'Must start with a letter and be alphanumeric.';

    saveUsernameBtn.disabled = true;
    saveUsernameBtn.textContent = 'Saving...';

    try {
      const response = await fetch(`${API_BASE_URL}/api/users/${userId}/username`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ newUsername })
      });

      let result; const text = await response.text();
      try { result = JSON.parse(text); } catch { result = { message: text }; }

      if (response.ok) {
        if (result && result.username) localStorage.setItem('username', result.username);
        if (result && result.token)       localStorage.setItem('token', result.token);
        if (result && result.expiry)   localStorage.setItem('token_expiry', String(result.expiry));

        // Re-hydrate from backend so localStorage has the latest username & photo
        try {
          const meRes = await fetch(`${API_BASE_URL}/api/users/me`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (meRes.ok) {
            const me = await meRes.json();
            if (me.username) localStorage.setItem('username', me.username);
            if (me.profile_picture_url) localStorage.setItem('profile_picture', me.profile_picture_url);
            else localStorage.removeItem('profile_picture');
          }
        } catch (_) {}

        showAlert(result?.message || 'Username updated successfully!');
        renderLoggedIn();
        closeEditUsernameModal();
      } else {
        usernameErrorMsg.textContent = result.message || 'An error occurred.';
      }
    } catch (error) {
      console.error('Failed to update username:', error);
      usernameErrorMsg.textContent = 'A network error occurred. Please try again.';
    } finally {
      saveUsernameBtn.disabled = false;
      saveUsernameBtn.textContent = 'Save';
    }
  }

  // --- UI RENDERING ---
  function renderLoggedIn() {
    const currentUsername = localStorage.getItem('username');
    const currentProfilePicture = localStorage.getItem('profile_picture');
    const hasProfilePic = !!currentProfilePicture;

    profileContainer.innerHTML = '';

    const img = document.createElement('img');
    img.id = 'profile-image';
    img.className = "w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-blue-500 shadow-md";
    img.src = hasProfilePic ? toPhotoSrc(currentProfilePicture) : `https://placehold.co/120x120/E2E8F0/4A5568?text=User`;
    img.onerror = () => img.src = `https://placehold.co/120x120/E2E8F0/4A5568?text=User`;
    profileContainer.appendChild(img);

    if (hasProfilePic) {
      const buttonWrapper = document.createElement('div');
      buttonWrapper.className = 'absolute bottom-0 -right-2 flex items-center space-x-1';
      buttonWrapper.innerHTML = `
        <button id="edit-pic-btn" title="Change Photo" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-700 transition shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
        </button>
        <button id="remove-pic-btn" title="Remove Photo" class="bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-700 transition shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      `;
      profileContainer.appendChild(buttonWrapper);
      document.getElementById('edit-pic-btn').onclick = handleProfileUpload;
      document.getElementById('remove-pic-btn').onclick = removeProfilePicture;
    } else {
      img.classList.replace('border-blue-500', 'border-gray-400');
      const addButton = document.createElement('button');
      addButton.id = 'add-pic-btn';
      addButton.title = 'Add Photo';
      addButton.className = 'absolute bottom-0 right-0 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-green-600 transition shadow-md';
      addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
      profileContainer.appendChild(addButton);
      addButton.onclick = handleProfileUpload;
    }

    greetingContainer.innerHTML = `
      <span id="greeting-text">Hi, ${currentUsername || 'User'}</span>
      <button id="edit-username-btn" title="Edit Username" class="p-1 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
      </button>
    `;
    document.getElementById('edit-username-btn').onclick = openEditUsernameModal;

    authButton.textContent = 'Logout';
    authButton.onclick = function () {
      const token = localStorage.getItem('token');
      localStorage.removeItem('token');
      localStorage.removeItem('token_expiry');
      localStorage.removeItem('username');
      localStorage.removeItem('profile_picture');
      localStorage.removeItem('userid');

      fetch(`${API_BASE_URL}/api/users/logout`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      }).finally(() => {
        renderLoggedOut();
      });
    };
    protectActionButtons();
    loadAccountData();
  }

  function renderLoggedOut() {
    profileContainer.innerHTML = `
      <img src="https://placehold.co/120x120/E2E8F0/4A5568?text=User"
           class="w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-gray-400 shadow-md" />
    `;
    greetingContainer.innerHTML = '<span>You are logged out</span>';
    authButton.textContent = 'Login';
    authButton.onclick = function () {
      window.location.replace("/");
    };
    protectActionButtons();
  }

  // --- BUTTON PROTECTION ---
  function protectActionButtons() {
    const loggedIn = !!localStorage.getItem('token');

    const buttons = [
        { id: "save-build", text: "Save" },
        { id: "add-to-cart", text: "Add to Cart" },
        { id: "buy-now", text: "Buy Now" }
    ];

    buttons.forEach(btnData => {
        const btn = document.getElementById(btnData.id);
        if (!btn) return;

        if (!loggedIn) {
            btn.disabled = true;
            btn.classList.add("opacity-50", "cursor-not-allowed");
            btn.title = "Please sign in first";
        } else {
            btn.disabled = false;
            btn.classList.remove("opacity-50", "cursor-not-allowed");
            btn.title = "";
        }
    });
  }
  
  // --- ACCOUNT DATA ---
  async function loadAccountData() {
      const userId = localStorage.getItem("userid");
      const token = localStorage.getItem("token");
      if (!userId || !token) {
        // Clear out any stale data if user is logged out
        document.getElementById("saved-tab").innerHTML = '<p class="text-gray-500">Please log in to see your saved builds.</p>';
        document.getElementById("cart-tab").innerHTML = '<p class="text-gray-500 col-span-full text-center">Please log in to see your cart.</p>';
        document.getElementById("orders-tab").innerHTML = '<p class="text-gray-500">Please log in to see your orders.</p>';
        return;
      }

      const [savedRes, ordersRes] = await Promise.all([
          fetch(`${API_BASE_URL}/api/savedpc/${userId}`, { headers: { Authorization: `Bearer ${token}` } }),
          // Note: Cart is now handled by local storage, so we don't fetch it here.
          fetch(`${API_BASE_URL}/api/orders/${userId}`, { headers: { Authorization: `Bearer ${token}` } })
      ]);

      const saved = savedRes.ok ? await savedRes.json() : [];
      const orders = ordersRes.ok ? await ordersRes.json() : [];

      renderList("saved-tab", saved, "Saved Builds");
      // Cart rendering is now triggered by loadCartFromStorage
      renderOrders("orders-tab", orders);
  }

  function renderList(containerId, items, title) {
      const container = document.getElementById(containerId);
      container.innerHTML = items.length ? 
          items.map(item => `<div class="p-3 bg-gray-100 dark:bg-gray-700 rounded mb-2">${item.name || "Build #" + item.id}</div>`).join("")
          : `<p class="text-gray-500">No ${title}</p>`;
  }

  function renderOrders(containerId, orders) {
      const container = document.getElementById(containerId);
      container.innerHTML = orders.length ? 
          orders.map(order => `
            <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded mb-3">
              <p><b>Order #${order.id}</b></p>
              <p>Status: ${order.status}</p>
              <div class="w-full bg-gray-300 rounded-full h-2 mt-2">
                <div class="bg-blue-600 h-2 rounded-full" style="width: ${
                  order.status === 'Pending' ? '25%' : 
                  order.status === 'Processing' ? '50%' : 
                  order.status === 'Shipped' ? '75%' : '100%'
                }"></div>
              </div>
            </div>`).join("")
          : `<p class="text-gray-500">No Orders Yet</p>`;
  }


  // --- EVENT LISTENERS & INITIALIZATION (single block, async) ---
  document.addEventListener('DOMContentLoaded', async () => {
    // Account page event listeners
    profileUploadInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        imageToCrop.src = event.target.result;
        cropModal.classList.remove('hidden');
        if (cropper) cropper.destroy();
        cropper = new Cropper(imageToCrop, {
          aspectRatio: 1, viewMode: 1, background: false,
          responsive: true, autoCropArea: 0.8, checkOrientation: false,
          movable: true, rotatable: true, scalable: true, zoomable: true,
          guides: false, cropBoxResizable: false, dragMode: 'move'
        });
      };
      reader.readAsDataURL(file);
      profileUploadInput.value = '';
    });

    setCropBtn.addEventListener('click', () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' });
      canvas.toBlob((blob) => {
        const userId = localStorage.getItem('userid');
        uploadProfilePicture(userId, blob);
        const localUrl = URL.createObjectURL(blob);
        const profileImage = document.getElementById('profile-image');
        if (profileImage) profileImage.src = localUrl;
        cropper.destroy();
        cropper = null;
        cropModal.classList.add('hidden');
      }, 'image/jpeg');
    });

    cancelCropBtn.addEventListener('click', () => {
      if (cropper) cropper.destroy();
      cropper = null;
      cropModal.classList.add('hidden');
    });

    saveUsernameBtn.addEventListener('click', handleUsernameSave);
    cancelUsernameBtn.addEventListener('click', closeEditUsernameModal);
    customAlertOkBtn.addEventListener('click', () => customAlertModal.classList.add('hidden'));

    // 🔥 Auth bootstrap with hydration (now using readExpiryMs)
    const token  = localStorage.getItem('token');
    const expiryMs = readExpiryMs();
    const userId  = localStorage.getItem('userid');
    const tokenIsValid = token && expiryMs && Date.now() < expiryMs;

    try {
      if (tokenIsValid) {
        if (!userId) {
          const meRes = await fetch(`${API_BASE_URL}/api/users/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!meRes.ok) throw new Error('Failed to fetch profile');
          const me = await meRes.json();
          if (me.id)       localStorage.setItem('userid', me.id);
          if (me.username) localStorage.setItem('username', me.username);
          else             localStorage.setItem('username', 'User');
          if (me.profile_picture_url) {
            localStorage.setItem('profile_picture', me.profile_picture_url);
          } else {
            localStorage.removeItem('profile_picture');
          }
        }
        renderLoggedIn();
      } else {
        renderLoggedOut();
      }
    } catch (e) {
      console.error(e);
      localStorage.removeItem('token');
      localStorage.removeItem('token_expiry');
      renderLoggedOut();
    }
  });
</script>

    <script>
        // --- MAIN SITE NAVIGATION, PC BUILDER & PREBUILDS LOGIC ---
        async function loadCart() {
  try {
    const response = await fetch('/cart.json');
    if (!response.ok) return [];
    return await response.json();
  } catch (error) {
    console.error("Failed to load cart.json:", error);
    return [];
  }
}

async function saveCart(cart) {
  try {
    await fetch('/save-cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cart, null, 2)
    });
  } catch (error) {
    console.error("Failed to save cart.json:", error);
  }
}

document.getElementById('add-to-cart').addEventListener('click', async () => {
  let cart = await loadCart();
  if (!Array.isArray(cart)) cart = [];

  const buildSummary = document.getElementById('build-summary').innerText;
  const price = document.getElementById('total-price').innerText;
  const quantity = parseInt(document.getElementById('build-quantity').value, 10);

  const newItem = { summary: buildSummary, price, quantity };
  cart.push(newItem);
  await saveCart(cart);
  alert("Build added to cart.json successfully!");
});
        
        document.addEventListener('DOMContentLoaded', async () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileMenuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleBtnMobile = document.getElementById('theme-toggle-mobile');

            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const sunIconMobile = document.getElementById('sun-icon-mobile');
            const moonIconMobile = document.getElementById('moon-icon-mobile');

            let currentPage = null;

            // --- CART LOGIC (NEW) ---
            let cart = [];

            const loadCartFromStorage = () => {
                const cartData = JSON.parse(localStorage.getItem('cart') || '[]');
                const currentUserId = localStorage.getItem('userid');
                cart = currentUserId ? cartData.filter(item => item.userId === currentUserId) : [];
                renderCart();
            };

            const saveCartToStorage = () => {
                const allCarts = JSON.parse(localStorage.getItem('cart') || '[]');
                const currentUserId = localStorage.getItem('userid');
                // Remove old items for this user and add the updated ones
                const otherUsersCarts = allCarts.filter(item => item.userId !== currentUserId);
                const updatedCart = [...otherUsersCarts, ...cart];
                localStorage.setItem('cart', JSON.stringify(updatedCart));
            };

            const addToCart = (build) => {
                 const currentUserId = localStorage.getItem('userid');
                 if (!currentUserId) {
                    showAlert("Please log in to add items to your cart.");
                    return;
                 }
                 const cartItem = {
                     ...build,
                     cartId: `cart-${Date.now()}`, // Unique ID for the cart item
                     userId: currentUserId
                 };
                 cart.push(cartItem);
                 saveCartToStorage();
                 showAlert(`${build.name} has been added to your cart!`);
                 renderCart();
            };

            const removeFromCart = async (cartId) => {
                const confirmed = await showConfirm("Are you sure you want to remove this item from your cart?");
                if(confirmed) {
                    cart = cart.filter(item => item.cartId !== cartId);
                    saveCartToStorage();
                    renderCart();
                }
            };
            
            const showPage = (pageId) => {
                const newPage = document.getElementById(pageId);
                if (!newPage || newPage === currentPage) return;

                if (currentPage) {
                    currentPage.classList.remove('active');
                }
                
                newPage.classList.add('active');
                currentPage = newPage;
                
                if (pageId === 'build-pc-page') {
                    showDisclaimer();
                }

                // Trigger scroll animations on the new page
                const scrollElements = newPage.querySelectorAll('.scroll-animate');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, { threshold: 0.1 });

                scrollElements.forEach(el => observer.observe(el));
            };

            const handleNavLinkClick = (e) => {
                e.preventDefault();
                const target = e.currentTarget;
                const pageId = target.getAttribute('href').substring(1) + '-page';
                
                if (target.classList.contains('nav-link-cta')) {
                     showPage('build-pc-page');
                } else {
                    showPage(pageId);
                }
                
                mobileMenu.classList.add('hidden');
            };

            const toggleTheme = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
                updateThemeIcons(isDark);
            };
            
            const updateThemeIcons = (isDark) => {
                if (isDark) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                    sunIconMobile.classList.add('hidden');
                    moonIconMobile.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                    sunIconMobile.classList.remove('hidden');
                    moonIconMobile.classList.add('hidden');
                }
            };

            const initialTheme = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
            if (initialTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcons(initialTheme === 'dark');

            document.querySelectorAll('.nav-link, .nav-link-cta').forEach(link => link.addEventListener('click', handleNavLinkClick));
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            themeToggleBtn.addEventListener('click', toggleTheme);
            themeToggleBtnMobile.addEventListener('click', toggleTheme);

            // --- TAB SWITCHING ---
            document.addEventListener("click", (e) => {
              if (e.target.classList.contains("account-tab")) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll(".account-tab").forEach(btn => btn.classList.remove("font-bold", "text-blue-500"));
                e.target.classList.add("font-bold", "text-blue-500");

                document.querySelectorAll(".account-tab-content").forEach(div => div.classList.add("hidden"));
                document.getElementById(tab + "-tab").classList.remove("hidden");
              }
            });

            // --- DATA LOADING ---
            let components = {};
            let prebuilds = [];

            async function loadData() {
                try {
                    const [cabinetsRes, motherboardsRes, cpusRes, coolersRes, ramsRes, gpusRes, psusRes, storageRes] = await Promise.all([
                        fetch('/case.json'),
                        fetch('/mother_board.json'),
                        fetch('/cpu.json'),
                        fetch('/cooler.json'),
                        fetch('/ram.json'),
                        fetch('/gpu.json'),
                        fetch('/psu.json'),
                        fetch('/storage.json')
                    ]);

                    const cabinets = await cabinetsRes.json();
                    const motherboards = await motherboardsRes.json();
                    const cpus = await cpusRes.json();
                    const coolers = await coolersRes.json();
                    const rams = await ramsRes.json();
                    const gpus = await gpusRes.json();
                    const psus = await psusRes.json();
                    const storage = await storageRes.json();
                    
                    // FIX: Handle both 'price' and 'price_inr' keys
                    const renamePrice = (item) => ({ ...item, price: item.price_inr !== undefined ? item.price_inr : item.price });

                    components = {
                        cabinets: cabinets.map(renamePrice),
                        motherboards: motherboards.map(renamePrice),
                        cpus: cpus.map(renamePrice),
                        coolers: coolers.map(renamePrice),
                        rams: rams.map(renamePrice),
                        gpus: gpus.map(renamePrice),
                        psus: psus.map(renamePrice),
                        ssds: storage.filter(s => s.kind === 'SSD').map(renamePrice),
                        hdds: storage.filter(s => s.kind === 'HDD').map(renamePrice),
                        oss: [
                            { id: 'os-win', name: 'Windows 11', price: 8000, image: 'https://placehold.co/200x200/525252/FFF?text=Windows', versions: [{ name: 'Windows 11 Home', price: 8000 }, { name: 'Windows 11 Pro', price: 12000 }] },
                            { id: 'os-ubu', name: 'Ubuntu', price: 500, image: 'https://placehold.co/200x200/525252/FFF?text=Ubuntu', versions: [{ name: 'Ubuntu', price: 500 }] },
                            { id: 'os-kali', name: 'Kali Linux', price: 500, image: 'https://placehold.co/200x200/525252/FFF?text=Kali', versions: [{ name: 'Kali Linux', price: 500 }] }
                        ]
                    };
                    
                    // Define prebuilds using loaded data
                    prebuilds = [
                        {
                            id: 'prebuild-1',
                            name: 'The Starter',
                            price: 49400,
                            category: 'Gaming',
                            image: 'https://placehold.co/300x200/3b82f6/ffffff?text=The+Starter',
                            description: 'An excellent entry-point for 1080p gaming and everyday tasks. Balanced and budget-friendly.',
                            components: { cabinet: 'case-1', motherboard: 'mobo-1', cpu: 'cpu-107', cooler: 'cooler-1', ram: 'ram-2', ramCount: 1, gpu: 'gpu-1', psu: 'psu-1', ssd: 'storage-1', ssdCount: 1, hdd: null, hddCount: 0, os: 'os-win' }
                        },
                        {
                            id: 'prebuild-2',
                            name: 'The Raider',
                            price: 98400,
                            category: 'Gaming',
                            image: 'https://placehold.co/300x200/8b5cf6/ffffff?text=The+Raider',
                            description: 'A powerful mid-range rig designed to crush modern games at 1440p with high frame rates.',
                            components: { cabinet: 'case-3', motherboard: 'mobo-2', cpu: 'cpu-132', cooler: 'cooler-2', ram: 'ram-3', ramCount: 2, gpu: 'gpu-9', psu: 'psu-2', ssd: 'storage-9', ssdCount: 1, hdd: 'storage-25', hddCount: 1, os: 'os-win' }
                        },
                        {
                            id: 'prebuild-3',
                            name: 'The Titan',
                            price: 148300,
                            category: 'Professional (Video/Photo Editing)',
                            image: 'https://placehold.co/300x200/ec4899/ffffff?text=The+Titan',
                            description: 'A high-performance workstation for content creators and gamers who demand speed and power.',
                            components: { cabinet: 'case-5', motherboard: 'mobo-4', cpu: 'cpu-123', cooler: 'cooler-5', ram: 'ram-8', ramCount: 1, gpu: 'gpu-21', psu: 'psu-4', ssd: 'storage-12', ssdCount: 1, hdd: 'storage-31', hddCount: 1, os: 'os-win' }
                        }
                    ];

                    renderPrebuilds(prebuilds);

                } catch (error) {
                    console.error("Failed to load component data:", error);
                    showAlert("Could not load product data. Please check the console for errors and refresh the page.");
                }
            }
            
            await loadData();

            // --- PC BUILDER LOGIC ---

            const filterDefinitions = {
                cpu: ['brand', 'series', 'generation'],
                gpu: ['brand', 'family', 'generation'],
                motherboard: ['brand', 'socket', 'chipset', 'form_factor'],
                ram: ['brand', 'generation', 'capacity_gb'],
                cooler: ['brand', 'type'],
                psu: ['brand', 'wattage_w', 'efficiency_rating'],
                ssd: ['brand', 'family', 'capacity_gb'],
                hdd: ['brand', 'family', 'capacity_gb'],
                cabinet: ['brand', 'type']
            };

            let selectedComponents = {
                cabinet: null, motherboard: null, cpu: null, cooler: null, ram: null, ramCount: 1,
                gpu: null, psu: null, ssd: null, ssdCount: 1, hdd: null, hddCount: 1, os: null
            };
            
            let tempSelection = { component: null, count: 1 };

            const disclaimerPanel = document.getElementById('disclaimer-panel');
            const agreeCheckbox = document.getElementById('agree-checkbox');
            const startBuildBtn = document.getElementById('start-build-btn');
            const componentSelectionView = document.getElementById('component-selection-view');
            const finalizeBuildBtn = document.getElementById('finalize-build-btn');
            const deselectBtn = document.getElementById('deselect-component-btn');
            const filterContainer = document.getElementById('filter-container');

            let currentSelectionType = null;
            let currentBuildStep = 0;

            const showDisclaimer = () => {
                document.querySelectorAll('.build-step').forEach(panel => panel.classList.add('hidden'));
                disclaimerPanel.classList.remove('hidden');
                agreeCheckbox.checked = false;
                startBuildBtn.disabled = true;
                currentBuildStep = 0;
            };

            const showBuildStep = (step) => {
                const allSteps = document.querySelectorAll('.build-step, #disclaimer-panel, #component-selection-view');
                const newStepPanel = document.getElementById(`step-${step}`);
                
                allSteps.forEach(panel => {
                    if (panel !== newStepPanel) {
                        panel.classList.add('hidden');
                    }
                });

                if (newStepPanel) {
                    newStepPanel.classList.remove('hidden');
                }
                
                currentBuildStep = step;
                
                if (step === 1) updateStep1Panel();
                else if (step === 2) updateStep2Panel();
                else if (step === 3) showSummaryPanel();
            };
            
            const showComponentSelectionView = (type) => {
                document.querySelectorAll('.build-step, #disclaimer-panel, #component-details-page').forEach(panel => panel.classList.add('hidden'));
                componentSelectionView.classList.remove('hidden');
                document.getElementById('component-selection-title').textContent = `Select ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                currentSelectionType = type;
                tempSelection.component = selectedComponents[type];
                tempSelection.count = selectedComponents[`${type}Count`] || 1;
                renderFilters(type);
                applyFiltersAndRenderCards();
            };

            const showSummaryPanel = () => {
                showBuildStep(3);
                updateSummary();
            };

            const showComponentDetails = (componentId, type) => {
                const componentData = components[`${type}s`].find(c => c.id === componentId);
                if (!componentData) return;

                const detailsPage = document.getElementById('component-details-page');
                let detailsHtml = `
                    <div class="p-6 md:p-10 rounded-lg shadow-xl max-w-4xl mx-auto bg-white dark:bg-gray-800">
                        <button id="back-to-selection-from-details" class="text-blue-500 hover:text-blue-600 transition-colors font-semibold flex items-center space-x-2 mb-6">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            <span>Back to Selection</span>
                        </button>
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="md:w-1/3">
                                <img src="${componentData.image}" alt="${componentData.name}" class="w-full h-auto object-contain rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/200x200/ef4444/ffffff?text=Image+Error';">
                            </div>
                            <div class="md:w-2/3">
                                <h2 class="text-3xl font-bold mb-2">${componentData.name}</h2>
                                <p class="text-2xl font-semibold text-blue-500 mb-4">₹${componentData.price.toLocaleString('en-IN')}</p>
                                <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                                    <h3 class="text-lg font-semibold mb-2">Specifications</h3>
                                    <ul class="space-y-1 text-gray-700 dark:text-gray-300">
                `;

                for (const key in componentData) {
                    if (!['id', 'name', 'price', 'image', 'versions', 'price_inr'].includes(key)) {
                        const label = key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        detailsHtml += `<li class="flex justify-between"><strong>${label}:</strong> <span>${componentData[key]}</span></li>`;
                    }
                }

                detailsHtml += `
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                detailsPage.innerHTML = detailsHtml;

                document.querySelectorAll('.page, .build-step').forEach(p => p.classList.add('hidden'));
                showPage('component-details-page');


                document.getElementById('back-to-selection-from-details').addEventListener('click', () => {
                    detailsPage.classList.remove('active');
                    showPage('build-pc-page');
                    showComponentSelectionView(type);
                });
            };

            const renderFilters = (type) => {
                filterContainer.innerHTML = '';

                const filters = filterDefinitions[type];
                if (!filters) return;

                const bar = document.createElement('div');
                bar.className = 'mb-4 flex items-center justify-between';

                const title = document.createElement('div');
                title.className = 'text-sm font-semibold text-gray-700 dark:text-gray-200';
                title.textContent = 'Filters';

                const resetBtn = document.createElement('button');
                resetBtn.type = 'button';
                resetBtn.className = 'text-sm px-3 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                resetBtn.textContent = 'Clear Filters';
                resetBtn.addEventListener('click', () => {
                    filterContainer.querySelectorAll('select.filter-select').forEach(sel => { sel.value = ''; });
                    applyFiltersAndRenderCards();
                });

                bar.appendChild(title);
                bar.appendChild(resetBtn);
                filterContainer.appendChild(bar);

                const filterWrapper = document.createElement('div');
                filterWrapper.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4';

                const componentList = components[`${type}s`];
                let currentList = componentList;

                filters.forEach((filterKey, index) => {
                    const group = document.createElement('div');
                    group.className = 'space-y-1';

                    const label = document.createElement('label');
                    label.className = 'block text-xs font-medium text-gray-600 dark:text-gray-300';
                    label.textContent = filterKey.replace(/_/g, ' ').replace(/^./, str => str.toUpperCase());

                    const select = document.createElement('select');
                    select.className = 'filter-select';
                    select.dataset.filter = filterKey;

                    const placeholder = `All ${filterKey.replace(/_/g, ' ')}`;
                    select.innerHTML = `<option value="">${placeholder}</option>`;

                    const options = [...new Set(currentList.map(item => item[filterKey]))].sort();
                    options.forEach(option => {
                        if (option) select.innerHTML += `<option value="${option}">${option}</option>`;
                    });

                    select.addEventListener('change', () => {
                        let nextList = components[`${type}s`];

                        for (let i = 0; i <= index; i++) {
                            const k = filters[i];
                            const val = filterWrapper.querySelector(`[data-filter="${k}"]`)?.value;
                            if (val) nextList = nextList.filter(item => String(item[k]) === val);
                        }

                        for (let j = index + 1; j < filters.length; j++) {
                            const k2 = filters[j];
                            const sel2 = filterWrapper.querySelector(`[data-filter="${k2}"]`);
                            const ph2 = `All ${k2.replace(/_/g, ' ')}`;
                            sel2.innerHTML = `<option value="">${ph2}</option>`;
                            const opts2 = [...new Set(nextList.map(item => item[k2]))].sort();
                            opts2.forEach(opt => { if (opt) sel2.innerHTML += `<option value="${opt}">${opt}</option>`; });
                            sel2.value = '';
                        }

                        applyFiltersAndRenderCards();
                    });

                    group.appendChild(label);
                    group.appendChild(select);
                    filterWrapper.appendChild(group);
                });

                filterContainer.appendChild(filterWrapper);
            };

            const applyFiltersAndRenderCards = () => {
                const componentType = currentSelectionType;
                let filteredList = components[`${componentType}s`];
                
                const filters = filterDefinitions[componentType];
                if (filters) {
                    filters.forEach(filterKey => {
                        const filterValue = filterContainer.querySelector(`[data-filter="${filterKey}"]`)?.value;
                        if (filterValue) {
                            filteredList = filteredList.filter(item => String(item[filterKey]) === filterValue);
                        }
                    });
                }
                renderComponentCardsInSelectionView(filteredList);
            };
            
            const createNoneCard = (componentType) => {
                const noneCard = document.createElement('div');
                noneCard.className = `component-card bg-gray-100 dark:bg-gray-700 rounded-lg p-4 shadow-md text-center flex flex-col items-center justify-between border-2 border-transparent`;
                noneCard.onclick = () => {
                    document.querySelectorAll('#component-card-container .component-card').forEach(c => c.classList.remove('selected'));
                    noneCard.classList.add('selected');
                    tempSelection.component = null;
                    tempSelection.count = 1;
                };
                noneCard.innerHTML = `
                    <div class="w-full h-32 flex items-center justify-center text-5xl text-gray-400 dark:text-gray-500">N/A</div>
                    <h4 class="font-semibold text-lg my-2">None</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">₹0</p>
                    <div class="mt-4 w-full">
                        <button class="choose-component-btn bg-blue-500 text-white w-full py-2 rounded-full font-bold">Choose</button>
                    </div>
                `;
                if (selectedComponents[componentType] === null) noneCard.classList.add('selected');
                const chooseBtn = noneCard.querySelector('.choose-component-btn');
                chooseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    noneCard.click();
                    selectComponentInView();
                });
                return noneCard;
            };
            
            const renderComponentCardsInSelectionView = (componentList) => {
                const container = document.getElementById('component-card-container');
                container.innerHTML = '';
                
                const componentType = currentSelectionType;

                if (!['cabinet', 'motherboard', 'cpu', 'psu'].includes(componentType)) {
                    container.appendChild(createNoneCard(componentType));
                }

                if (!componentList) return;

                componentList.forEach(component => {
                    const card = document.createElement('div');
                    card.className = `component-card bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow-md text-center flex flex-col items-center justify-between border-2 border-transparent`;
                    card.setAttribute('data-id', component.id);
                    
                    let selectorHtml = '';
                    if (['ram', 'ssd', 'hdd'].includes(componentType)) {
                        const maxSlots = (componentType === 'ram') ? (selectedComponents.motherboard?.ram_slots || 1) : (componentType === 'ssd' ? (selectedComponents.motherboard?.m2_slots || 1) : 4);
                        let optionsHtml = '';
                        for (let i = 1; i <= maxSlots; i++) optionsHtml += `<option value="${i}">${i}</option>`;
                        selectorHtml = `<div class="mt-4 flex items-center justify-center space-x-2"><label for="count-${component.id}" class="text-sm">Sticks:</label><select id="count-${component.id}" class="w-20 p-1 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-500 text-center">${optionsHtml}</select></div>`;
                    } else if (componentType === 'os' && component.versions) {
                        let optionsHtml = '';
                        component.versions.forEach(v => { optionsHtml += `<option value="${v.name}">${v.name} (₹${v.price.toLocaleString('en-IN')})</option>`; });
                        selectorHtml = `<div class="mt-4 flex flex-col space-y-2 text-left w-full"><label for="version-${component.id}" class="text-sm">Version:</label><select id="version-${component.id}" class="p-1 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-500 w-full">${optionsHtml}</select></div>`;
                    }
                    
                    card.innerHTML = `
                        <img src="${component.image}" alt="${component.name}" class="w-full h-32 object-contain rounded-md mb-2" onerror="this.onerror=null;this.src='https://placehold.co/200x200/ef4444/ffffff?text=Image+Error';">
                        <h4 class="font-semibold text-lg my-2">${component.name}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${(componentType !== 'os') ? '₹' + component.price.toLocaleString('en-IN') : ''}</p>
                        ${selectorHtml}
                        <div class="mt-4 w-full flex flex-col sm:flex-row gap-2">
                           <button class="details-btn bg-gray-500 text-white w-full py-2 rounded-full font-bold hover:bg-gray-600 transition-colors">Details</button>
                           <button class="choose-component-btn bg-blue-500 text-white w-full py-2 rounded-full font-bold hover:bg-blue-600 transition-colors">Choose</button>
                        </div>
                    `;
                    
                    card.onclick = () => {
                        document.querySelectorAll('#component-card-container .component-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        tempSelection.component = component;
                        const countSelector = card.querySelector('select[id^="count-"]');
                        tempSelection.count = countSelector ? parseInt(countSelector.value) || 1 : 1;
                    };
                    
                    if (selectedComponents[componentType]?.id === component.id) {
                        card.classList.add('selected');
                        const countSelector = card.querySelector(`select[id^="count-"]`);
                        const versionSelector = card.querySelector(`select[id^="version-"]`);
                        if(versionSelector && componentType === 'os') versionSelector.value = selectedComponents[componentType].name;
                        else if (countSelector) countSelector.value = selectedComponents[`${componentType}Count`];
                        tempSelection.component = selectedComponents[componentType];
                        tempSelection.count = selectedComponents[`${componentType}Count`] || 1;
                    }
                    
                    card.querySelector('.choose-component-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        card.click();
                        selectComponentInView();
                    });

                    card.querySelector('.details-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showComponentDetails(component.id, componentType);
                    });

                    container.appendChild(card);
                });
            };
            
            const selectComponentInView = () => {
                const componentType = currentSelectionType;
                selectedComponents[componentType] = tempSelection.component;

                if (componentType === 'os' && tempSelection.component) {
                    const selectedVersionName = document.querySelector(`#version-${tempSelection.component.id}`).value;
                    const originalComponent = components.oss.find(c => c.id === tempSelection.component.id);
                    const selectedVersion = originalComponent.versions.find(v => v.name === selectedVersionName);
                    selectedComponents.os = { ...originalComponent, ...selectedVersion, name: selectedVersion.name, price: selectedVersion.price };
                } else if (['ram', 'ssd', 'hdd'].includes(componentType) && tempSelection.component) {
                    selectedComponents[`${componentType}Count`] = tempSelection.count;
                }
                
                updateTotalPrice();
                
                if (['cabinet', 'motherboard'].includes(componentType)) showBuildStep(1);
                else showBuildStep(2);
            };

            const updateStep1Panel = () => {
                document.getElementById('selected-cabinet').textContent = selectedComponents.cabinet?.name || 'None';
                document.getElementById('selected-motherboard').textContent = selectedComponents.motherboard?.name || 'None';
                checkStep1Completion();
            };
            
            const updateStep2Panel = () => {
                document.getElementById('selected-cpu').textContent = selectedComponents.cpu?.name || 'None';
                document.getElementById('selected-cooler').textContent = selectedComponents.cooler?.name || 'None';
                document.getElementById('selected-ram').textContent = selectedComponents.ram ? `${selectedComponents.ram.name} (${selectedComponents.ramCount} sticks)` : 'None';
                document.getElementById('selected-gpu').textContent = selectedComponents.gpu?.name || 'None';
                document.getElementById('selected-psu').textContent = selectedComponents.psu?.name || 'None';
                document.getElementById('selected-ssd').textContent = selectedComponents.ssd ? `${selectedComponents.ssd.name} (${selectedComponents.ssdCount} sticks)` : 'None';
                document.getElementById('selected-hdd').textContent = selectedComponents.hdd ? `${selectedComponents.hdd.name} (${selectedComponents.hddCount} sticks)` : 'None';
                document.getElementById('selected-os').textContent = selectedComponents.os?.name || 'None';
                checkCompletion();
            };

            const checkStep1Completion = () => {
                document.getElementById('next-step-1').disabled = !(selectedComponents.cabinet && selectedComponents.motherboard);
            };
            
            const checkCompletion = () => {
                document.getElementById('finalize-build-btn').disabled = !(selectedComponents.cpu && selectedComponents.psu && selectedComponents.ram);
            };
            
            const updateTotalPrice = () => {
                let total = 0;
                total += selectedComponents.cabinet?.price || 0;
                total += selectedComponents.motherboard?.price || 0;
                total += selectedComponents.cpu?.price || 0;
                total += selectedComponents.cooler?.price || 0;
                total += (selectedComponents.ram?.price || 0) * (selectedComponents.ramCount || 1);
                total += selectedComponents.gpu?.price || 0;
                total += selectedComponents.psu?.price || 0;
                total += (selectedComponents.ssd?.price || 0) * (selectedComponents.ssdCount || 1);
                total += (selectedComponents.hdd?.price || 0) * (selectedComponents.hddCount || 1);
                total += selectedComponents.os?.price || 0;
                const quantity = parseInt(document.getElementById('build-quantity').value) || 1;
                document.getElementById('total-price').textContent = `₹${(total * quantity).toLocaleString('en-IN')}`;
                 return total;
            };

            const updateSummary = () => {
                const summaryList = document.querySelector('#build-summary ul');
                summaryList.innerHTML = '';
                
                const createSummaryItem = (label, component, count = 1) => {
                    if (!component) {
                        summaryList.innerHTML += `<li class="flex justify-between"><span>${label}:</span> <span>None</span></li>`;
                        return;
                    }
                    let nameText = component.name;
                    if (['RAM', 'SSD', 'HDD'].includes(label.toUpperCase()) && count > 1) {
                         nameText += ` (${count} sticks)`;
                    }
                    summaryList.innerHTML += `<li class="flex justify-between items-center"><span><span class="font-medium">${label}:</span> <span class="text-gray-600 dark:text-gray-400">${nameText}</span></span><span class="font-semibold">₹${(component.price * count).toLocaleString('en-IN')}</span></li>`;
                };

                createSummaryItem('Cabinet', selectedComponents.cabinet);
                createSummaryItem('Motherboard', selectedComponents.motherboard);
                createSummaryItem('CPU', selectedComponents.cpu);
                createSummaryItem('Cooler', selectedComponents.cooler);
                createSummaryItem('RAM', selectedComponents.ram, selectedComponents.ramCount);
                createSummaryItem('GPU', selectedComponents.gpu);
                createSummaryItem('PSU', selectedComponents.psu);
                createSummaryItem('SSD', selectedComponents.ssd, selectedComponents.ssdCount);
                createSummaryItem('HDD', selectedComponents.hdd, selectedComponents.hddCount);
                createSummaryItem('OS', selectedComponents.os);
                updateTotalPrice();
            };
            
            const goBackToBuilder = () => {
                 showBuildStep(currentBuildStep);
            };

            agreeCheckbox.addEventListener('change', () => { startBuildBtn.disabled = !agreeCheckbox.checked; });
            startBuildBtn.addEventListener('click', () => showBuildStep(1));
            document.getElementById('next-step-1').addEventListener('click', () => showBuildStep(2));
            document.getElementById('prev-step-2').addEventListener('click', () => showBuildStep(1));
            document.querySelectorAll('.select-component-btn').forEach(button => {
                button.addEventListener('click', (e) => showComponentSelectionView(e.currentTarget.dataset.type));
            });
            document.getElementById('back-to-builder-btn').addEventListener('click', goBackToBuilder);
            deselectBtn.addEventListener('click', () => {
                if (currentSelectionType) {
                    tempSelection.component = null;
                    tempSelection.count = 1;
                    selectComponentInView();
                }
            });
            document.getElementById('finalize-build-btn').addEventListener('click', showSummaryPanel);
            document.getElementById('prev-step-3').addEventListener('click', () => showBuildStep(2));
            document.getElementById('build-quantity').addEventListener('change', updateTotalPrice);
            
            document.getElementById('add-to-cart').addEventListener('click', () => {
                const build = {
                  name: 'Custom Build',
                  price: updateTotalPrice(),
                  quantity: parseInt(document.getElementById('build-quantity').value) || 1,
                  image: 'https://placehold.co/300x200/7c3aed/ffffff?text=Custom+Build',
                  components: {
                    cabinet: selectedComponents.cabinet?.id || null,
                    motherboard: selectedComponents.motherboard?.id || null,
                    cpu: selectedComponents.cpu?.id || null,
                    cooler: selectedComponents.cooler?.id || null,
                    ram: selectedComponents.ram?.id || null,
                    ramCount: selectedComponents.ramCount,
                    gpu: selectedComponents.gpu?.id || null,
                    psu: selectedComponents.psu?.id || null,
                    ssd: selectedComponents.ssd?.id || null,
                    ssdCount: selectedComponents.ssdCount,
                    hdd: selectedComponents.hdd?.id || null,
                    hddCount: selectedComponents.hddCount,
                    os: selectedComponents.os?.id || null
                  }
                };
                addToCart(build);
            });

            document.getElementById('save-build').addEventListener('click', () => showAlert('PC build saved!'));
            document.getElementById('buy-now').addEventListener('click', () => showAlert('Redirecting to checkout for your custom PC!'));

            // --- PREBUILDS LOGIC ---
            const prebuildContainer = document.getElementById('prebuild-card-container');
            const categoryFilter = document.getElementById('category-filter');
            const priceFilter = document.getElementById('price-filter');
            const prebuildModal = document.getElementById('prebuild-details-modal');
            const prebuildModalTitle = document.getElementById('prebuild-details-title');
            const prebuildModalContent = document.getElementById('prebuild-details-content');
            const closePrebuildModalBtn = document.getElementById('close-prebuild-details-btn');

            const renderPrebuilds = (buildsToRender) => {
                prebuildContainer.innerHTML = '';
                if (buildsToRender.length === 0) {
                    prebuildContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">No matching builds found.</p>`;
                    return;
                }
                buildsToRender.forEach(build => {
                    const card = document.createElement('div');
                    card.className = 'prebuild-card bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden';
                    card.setAttribute('data-id', build.id);
                    card.innerHTML = `
                        <img src="${build.image}" alt="${build.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/ef4444/ffffff?text=Image+Error';">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${build.name}</h3>
                            <p class="text-lg font-semibold text-blue-500 mb-3">₹${build.price.toLocaleString('en-IN')}</p>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">${build.description}</p>
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">${build.category}</span>
                        </div>
                    `;
                    card.addEventListener('click', () => showPrebuildDetails(build.id));
                    prebuildContainer.appendChild(card);
                });
            };

            const showPrebuildDetails = (buildId) => {
                const build = prebuilds.find(b => b.id === buildId);
                if (!build) return;

                prebuildModalTitle.textContent = build.name;
                let contentHtml = `<p class="text-gray-600 dark:text-gray-400 mb-6">${build.description}</p><h4 class="text-lg font-semibold mb-3">Components:</h4><ul class="space-y-2 text-sm">`;
                
                const getComponent = (type, id) => {
                    const key = type === 'cabinet' ? 'cabinets' : `${type}s`;
                    return components[key].find(c => c.id === id);
                };

                Object.entries(build.components).forEach(([key, value]) => {
                    if (value && !key.endsWith('Count')) {
                        const component = getComponent(key, value);
                        if (component) {
                             const label = key.charAt(0).toUpperCase() + key.slice(1);
                             let nameText = component.name;
                             if (build.components[`${key}Count`] > 1) {
                                  nameText += ` (x${build.components[`${key}Count`]})`;
                             }
                             contentHtml += `<li class="flex justify-between items-center p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                <span class="font-medium text-gray-800 dark:text-gray-200">${label}:</span>
                                <span class="text-gray-600 dark:text-gray-400 text-right">${nameText}</span>
                              </li>`;
                        }
                    }
                });

                contentHtml += `</ul><div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
                    <p class="text-xl font-bold">Total: <span class="text-blue-500">₹${build.price.toLocaleString('en-IN')}</span></p>
                    <div class="flex space-x-2">
                        <button id="add-prebuild-to-cart-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-full hover:bg-green-600 transition-colors">Add to Cart</button>
                         <button id="edit-prebuild-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-700 transition-colors">Edit</button>
                         <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors">Buy Now</button>
                    </div>
                </div>`;
                prebuildModalContent.innerHTML = contentHtml;
                prebuildModal.classList.remove('hidden');

                document.getElementById('edit-prebuild-btn').addEventListener('click', () => editPrebuild(buildId));
                document.getElementById('add-prebuild-to-cart-btn').addEventListener('click', () => {
                    addToCart(build);
                    prebuildModal.classList.add('hidden');
                });
            };
            
            const editPrebuild = (buildId) => {
                const build = prebuilds.find(b => b.id === buildId) || cart.find(b => b.cartId === buildId);
                if (!build) return;
                
                // Reset current selections
                Object.keys(selectedComponents).forEach(key => {
                    selectedComponents[key] = null;
                });
                selectedComponents.ramCount = 1;
                selectedComponents.ssdCount = 1;
                selectedComponents.hddCount = 1;


                // Populate selections from the prebuild
                Object.entries(build.components).forEach(([type, id]) => {
                    if (id && !type.endsWith('Count')) {
                        const key = type === 'cabinet' ? 'cabinets' : `${type}s`;
                        const componentData = components[key].find(c => c.id === id);
                        selectedComponents[type] = componentData;
                    } else if (type.endsWith('Count')) {
                        selectedComponents[type] = id;
                    }
                });

                prebuildModal.classList.add('hidden');
                showPage('build-pc-page');
                // We go to step 1 first to ensure the UI is consistent
                showBuildStep(1); 
                // Then immediately to step 2 where the user can see and edit components
                showBuildStep(2);
            };

            const filterPrebuilds = () => {
                const selectedCategory = categoryFilter.value;
                const [minPrice, maxPrice] = priceFilter.value.split('-').map(Number);

                let filtered = prebuilds.filter(build => {
                    const categoryMatch = selectedCategory === 'all' || build.category === selectedCategory;
                    const priceMatch = priceFilter.value === 'all' || (build.price >= minPrice && build.price <= maxPrice);
                    return categoryMatch && priceMatch;
                });
                renderPrebuilds(filtered);
            };

             const renderCart = () => {
                const container = document.getElementById('cart-tab');
                container.innerHTML = '';
                if(cart.length === 0){
                    container.innerHTML = '<p class="text-gray-500 col-span-full text-center">Your cart is empty.</p>';
                    return;
                }

                cart.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'prebuild-card bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col';
                    
                    const cpu = item.components.cpu ? components.cpus.find(c => c.id === item.components.cpu)?.name : 'N/A';
                    const gpu = item.components.gpu ? components.gpus.find(c => c.id === item.components.gpu)?.name : 'N/A';
                    const ram = item.components.ram ? components.rams.find(c => c.id === item.components.ram)?.name : 'N/A';

                    card.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/ef4444/ffffff?text=Image+Error';">
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-xl font-bold mb-2">${item.name}</h3>
                            <p class="text-lg font-semibold text-blue-500 mb-3">₹${(item.price * item.quantity).toLocaleString('en-IN')} ${item.quantity > 1 ? `(${item.quantity} units)` : ''}</p>
                            <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1 mb-4 flex-grow">
                                <p><strong>CPU:</strong> ${cpu}</p>
                                <p><strong>GPU:</strong> ${gpu}</p>
                                <p><strong>RAM:</strong> ${ram}</p>
                            </div>
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3 mt-auto grid grid-cols-3 gap-2">
                                <button data-cart-id="${item.cartId}" class="customize-cart-item text-sm bg-gray-600 text-white font-bold py-2 px-3 rounded-full hover:bg-gray-700 transition-colors">Customize</button>
                                <button class="buy-cart-item text-sm bg-blue-600 text-white font-bold py-2 px-3 rounded-full hover:bg-blue-700 transition-colors">Buy</button>
                                <button data-cart-id="${item.cartId}" class="remove-cart-item text-sm bg-red-600 text-white font-bold py-2 px-3 rounded-full hover:bg-red-700 transition-colors">Remove</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

                document.querySelectorAll('.customize-cart-item').forEach(btn => btn.addEventListener('click', (e) => editPrebuild(e.target.dataset.cartId)));
                document.querySelectorAll('.remove-cart-item').forEach(btn => btn.addEventListener('click', (e) => removeFromCart(e.target.dataset.cartId)));
                document.querySelectorAll('.buy-cart-item').forEach(btn => btn.addEventListener('click', () => showAlert('Redirecting to checkout!')));
             };


            categoryFilter.addEventListener('change', filterPrebuilds);
            priceFilter.addEventListener('change', filterPrebuilds);
            closePrebuildModalBtn.addEventListener('click', () => prebuildModal.classList.add('hidden'));

            // Initial render & load
            loadCartFromStorage();
            renderPrebuilds(prebuilds);


            // --- INITIAL PAGE LOAD ---
            const hashPage = window.location.hash.substring(1) || 'home';
            showPage(hashPage + '-page');
        });
    </script>
</body>
</html>
